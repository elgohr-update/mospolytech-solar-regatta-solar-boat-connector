# This configuration file was automatically generated by Gitpod.
# Please adjust to your needs (see https://www.gitpod.io/docs/config-gitpod-file)
# and commit this file to your remote git repository to share the goodness with others.

tasks:
  - name: Redis
    init: echo "starting redis"
    command: sudo service redis-server start

  - name: Postrgres
    init: echo "starting pg"
    command: ./scripts/create_databases_pod.sh

  - name: Venv
    init: |
      virtualenv venv
      source venv/bin/activate
      pip install -r requirements.txt
      ln -s ../solar-tester .
      cp .gitpod/gitpod.env .env
      gp sync-done venv

  - name: migrate
    init: gp sync-await venv
    command: |
      source venv/bin/activate
      ./scripts/migrate.sh

  - name: socat
    command: |
      socat -d -d pty,link=/tmp/vserial1,raw,echo=0 pty,link=/tmp/vserial2,raw,echo=0

  - name: Celery
    init: gp sync-await venv
    command: |
      source venv/bin/activate
      ./scripts/run_celery_dev.sh

  - name: Tester
    init: |
      ./scripts/update_tester_pod.sh
      cd ../solar-tester
      virtualenv venv
      source venv/bin/activate
      pip install -r requirements.txt
    command: |
      ./scripts/update_tester_pod.sh
      source venv/bin/activate
      pip install -r requirements.txt
      uvicorn --port 8080 main:app

image:
  file: .gitpod.dockerfile

ports:
  - name: Solar Tester
    description: Controller mocks console
    port: 8080
    onOpen: open-browser

additionalRepositories:
  - url: https://github.com/mospolytech-solar-regatta/solar-tester
    # checkoutLocation is relative to /workspaces
    checkoutLocation: solar-tester

github:
  prebuilds:
    # enable for the default branch (defaults to true)
    master: true
    # enable for all branches in this repo (defaults to false)
    branches: true
    # enable for pull requests coming from this repo (defaults to true)
    pullRequests: true
    # enable for pull requests coming from forks (defaults to false)
    pullRequestsFromForks: false
    # add a check to pull requests (defaults to true)
    addCheck: true
    # add a "Review in Gitpod" button as a comment to pull requests (defaults to false)
    addComment: false
    # add a "Review in Gitpod" button to the pull request's description (defaults to false)
    addBadge: false